This document provides a complete overview of the "RCM Buddy" web application's current state, architecture, file structure, key code components, database setup, and deployment steps using Netlify, GitHub, and Neon (PostgreSQL). It also includes a summary of issues encountered and their resolutions during recent development.

1. Project Goal
To provide a web application named "RCM Buddy" focused on Excel file manipulation, data validation, and process automation. Key features include:

User Management: Secure user registration and login.

Multi-Company Support: Allows multiple companies to use the application, with strict data isolation ensuring each company can only access its own data. Multiple users can belong to the same company.

File Management: Users can securely upload, store, list, download, and delete general Excel files and other documents directly within the company_files table in the Neon (PostgreSQL) database.

Data Dictionary Builder: A new tool allowing users to upload Excel/CSV files, extract headers, define custom validation rules for these headers, and save these structured data dictionaries to a separate dedicated database table (data_dictionaries). The original uploaded file is not stored on the server for this process. It also filters out already defined headers when building new dictionaries, and allows for editing and printing existing data dictionaries.

Data Validation Tool: An interactive client-side tool to analyze Excel/CSV files for data quality issues. This tool now exclusively applies custom validation rules from saved data dictionaries (from the data_dictionaries table) and checks for duplicate rows. Standard checks for blank cells, "NULL" strings, and future dates are no longer performed by this tool's primary logic.

Clean Data Tool: A client-side tool for basic Excel data cleaning (duplicates, trimming, case standardization).

Deployment: Automated deployment via Netlify, leveraging Netlify Functions for backend logic.

Version Control: GitHub.

2. Core Technologies Used
Frontend: HTML, CSS (Tailwind CSS for elements, custom CSS for others), JavaScript

Backend: Node.js (running as Netlify Functions)

Database: Neon (PostgreSQL) for user data, company data, general uploaded files (company_files table), and structured data dictionaries (data_dictionaries table).

Deployment Platform: Netlify

Version Control: GitHub

Authentication: JSON Web Tokens (JWT) for secure, stateless user sessions.

Password Hashing: bcryptjs.

File Upload Parsing: busboy (Node.js library for multipart/form-data).

Excel Processing (Client-side): xlsx.full.min.js (for Validation Engine analysis, Data Dictionary Builder header extraction, and report generation).

Excel Processing (Backend): exceljs (for Data Cleaner processing).

3. Current Project File Structure
rcm-buddy-app/
├── public/                                 <-- Static frontend files
│   ├── index.html                          <-- Login/Registration page
│   ├── dashboard.html                      <-- User dashboard with quick tool access
│   ├── tools.html                          <-- List of all tools (secondary access)
│   ├── file-manager.html                   <-- General file upload and listing page
│   └── tools/                              <-- Sub-directory for individual tool pages
│       ├── data-cleaner.html               <-- Data Cleaner UI
│       ├── validation-engine.html          <-- REVISED: Validation Engine UI (now self-contained HTML with embedded CSS & JS)
│       ├── data-dictionary-builder.html    <-- Data Dictionary Builder UI
│       ├── data-dictionary-builder.css     <-- Data Dictionary Builder custom CSS
│       └── data-dictionary-builder.js      <-- Data Dictionary Builder client-side logic
├── netlify/                                <-- Netlify Functions directory
│   └── functions/
│       ├── package.json                    <-- Function dependencies
│       ├── register.js                     <-- User/Company registration logic
│       ├── login.js                        <-- User login logic
│       ├── protected.js                    <-- JWT verification for protected routes
│       ├── upload-file.js                  <-- Handles general file upload to company_files DB
│       ├── list-files.js                   <-- Lists general files from company_files DB
│       ├── get-file.js                     <-- Retrieves general file data from company_files DB
│       ├── delete-file.js                  <-- Deletes general file from company_files DB
│       ├── clean-excel.js                  <-- Backend for Data Cleaner tool
│       ├── save-data-dictionary.js         <-- Saves structured data dictionary to data_dictionaries DB
│       ├── list-data-dictionaries.js       <-- NEW: Lists data dictionaries from data_dictionaries DB
│       ├── get-data-dictionary.js          <-- Retrieves specific data dictionary from data_dictionaries DB
│       └── delete-data-dictionary.js       <-- Deletes data dictionary from data_dictionaries DB
├── netlify.toml                            <-- Netlify build configuration
└── .gitignore                              <-- Git ignore rules

4. Database Schema
The application uses a PostgreSQL database (Neon) with the following tables:

companies table: Stores information about each client company.

CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

users table: Stores user credentials and links to their company.

-- Assuming existing users table, alter to add company_id
ALTER TABLE users
ADD COLUMN company_id INTEGER REFERENCES companies(id) ON DELETE RESTRICT;

company_files table: Stores metadata and the binary data of general uploaded files (e.g., Excel, CSV documents, not data dictionaries generated by the builder's primary output), with strict company and user ownership.

CREATE TABLE company_files (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    original_filename VARCHAR(255) NOT NULL,
    mimetype VARCHAR(100),
    size_bytes BIGINT,
    file_data BYTEA NOT NULL,
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

data_dictionaries table: Stores structured data dictionary definitions (validation rules) created by the Data Dictionary Builder. This table is separate from company_files and does not store the original source Excel files that were used to extract headers.

CREATE TABLE data_dictionaries (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    rules_json JSONB NOT NULL,
    source_headers_json JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE data_dictionaries
ADD CONSTRAINT unique_company_dictionary_name UNIQUE (company_id, name);

5. Key Code Components & Their Roles
5.1. netlify.toml
The primary configuration for Netlify deployment. It defines build directories, function paths, and API redirects.

[build]
  publish = "public"
  functions = "netlify/functions"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

[[plugins]]
package = "@netlify/plugin-functions-install-core"

5.2. Frontend Pages (public/ and public/tools/)
index.html: Login/Registration page. Handles user authentication. Site name changed from "Excel Buddy" to "RCM Buddy."

dashboard.html: The primary user dashboard. Authenticates via JWT, displays user and company information, and provides quick access (tool cards) to the main application features. Site name changed from "Excel Buddy" to "RCM Buddy" in the main title and main dashboard heading. Resolved "Hello, undefined" issue in navigation and now correctly displays "Your Company: [Company Name]" by accessing nested userData.user.company_name.

tools.html: A secondary page listing all available tools. It provides a more comprehensive overview of tools, now styled as responsive cards for visual consistency with the dashboard. Site name changed from "Excel Buddy" to "RCM Buddy" in the <title>. Resolved "Hello, undefined" issue in navigation, updated card styling, and removed extraneous "Coming Soon" placeholder tools (Report Automator, Macro Recorder & Editor, Custom Formula Builder).

file-manager.html: Handles uploading, listing, downloading, and deleting general files from the company_files table. Now includes a visual tag for files marked as "Data Dictionary." Site name changed from "Excel Buddy" to "RCM Buddy" in the <title>. Resolved "Hello, undefined" issue in navigation.

tools/data-cleaner.html: Provides the UI for client-side Excel data cleaning. Site name changed from "Excel Buddy" to "RCM Buddy" in the <title>. Resolved "Hello, undefined" issue" in navigation.

tools/validation-engine.html: REVISED. This file is now self-contained, embedding its CSS and JavaScript directly. Site name changed from "Excel Buddy" to "RCM Buddy" in the <title> and main heading.

Client-side validation using xlsx.full.min.js.

Data Dictionary Selection: Loads dropdowns from the list-data-dictionaries.js API.

Loads selected dictionary rules from the get-data-dictionary.js API.

Core Validation Logic: Now performs only custom validation rules (from loaded dictionaries) and duplicate row detection. Resolved issue where it was counting every row by implementing logic to skip validation for non-REQUIRED rules if a cell is empty/whitespace, and refined UNIQUE rule logic.

File Size Limit: Now limits processing to the first 5000 data rows of an XLSX file, with a warning message if the file exceeds this limit.

Applies rules and generates downloadable reports, including override functionality. Resolved "Hello, undefined" issue in navigation. Resolved "Export Excel with Summary" button not working by correcting iteration variable and filename.

tools/data-dictionary-builder.html: Provides UI for uploading Excel/CSV files, displaying extracted headers, and defining rules. Now supports selecting and editing existing dictionaries, and includes a "Print Report" button. The "Delete This Data Dictionary" button has been explicitly removed from the UI. Site name changed from "Excel Buddy" to "RCM Buddy" in the <title>. Resolved "Hello, undefined" issue in navigation.

tools/data-dictionary-builder.css: Custom CSS for the Data Dictionary Builder.

tools/data-dictionary-builder.js: Handles client-side Excel/CSV parsing to extract headers, dynamically builds the rule definition table, collects rules, sends data to save-data-dictionary.js, and allows editing/updating existing dictionaries and printing reports via handlePrintDictionary. The deleteDataDictionary function and its calls have been completely removed from this file. Resolved "Hello, undefined" issue in navigation, fixed dropdown population, implemented print functionality, and added pre-population of rules for new dictionaries based on existing rules from other saved dictionaries.

5.3. Backend Functions (netlify/functions/)
package.json: Lists Node.js dependencies (e.g., bcryptjs, jsonwebtoken, pg, busboy, exceljs).

register.js: Handles user and company registration.

login.js: Handles user login and JWT generation.

protected.js: Verifies JWTs for protected routes. Returns user data (including username and company_name) nested under a user object.

upload-file.js: Handles general file uploads to the company_files table.

list-files.js: Lists general files from the company_files table, now including the is_data_dictionary flag.

get-file.js: Retrieves general file data (base64 encoded in JSON) from the company_files table.

delete-file.js: Deletes general files from the company_files table.

clean-excel.js: Backend logic for the Data Cleaner tool.

save-data-dictionary.js: UPDATED: Authenticated function to save (INSERT for new, UPDATE for existing) a structured data dictionary (name, rules JSON, source headers JSON) into the data_dictionaries table. Now uses an explicit SELECT to check for existence before performing either an INSERT or an UPDATE (bypassing reliance on ON CONFLICT for broader database compatibility). Includes more detailed logging and a more explicit confirmation message in the response (e.g., "Data dictionary 'My Dictionary' saved successfully!").

list-data-dictionaries.js: NEW: Authenticated function to list metadata and all rules (rules_json) of data dictionaries from the data_dictionaries table. This allows the frontend to pre-populate rules from existing dictionaries.

get-data-dictionary.js: Authenticated function to retrieve the full rules_json and source_headers_json for a specific data dictionary from the data_dictionaries table.

delete-data-dictionary.js: Deletes data dictionary from the data_dictionaries table. This function remains in the backend, but its corresponding frontend UI button has been removed.

5.4. Data Isolation Strategy (CRUCIAL)
Company ID in JWT: company_id is embedded in the JWT upon successful login.

Backend Enforcement: All backend functions that interact with company-specific data (e.g., upload-file.js, list-files.js, get-file.js, delete-file.js, and all the data-dictionary- functions) MUST:

Verify the JWT.

Extract the company_id from the decoded JWT.

Include a WHERE company_id = <extracted_company_id> clause in ALL database queries (SELECT, INSERT, UPDATE, DELETE) to ensure strict data isolation.

6. Netlify Deployment & Configuration
Environment Variables:

DATABASE_URL: Your Neon PostgreSQL connection string.

JWT_SECRET: Your strong, random secret key.
These must be set in Netlify Site Settings > Build & Deploy > Environment Variables, with "Functions" scope enabled.

Continuous Deployment: Netlify automatically deploys changes pushed to the configured GitHub branch.

Function Bundling: The @netlify/plugin-functions-install-core plugin handles Node.js dependency installation for functions.

7. Common Issues & Troubleshooting
"Network or authentication error: Unexpected token '<', "<!DOCTYPE "... is not valid JSON": Frontend expecting JSON but received HTML. Usually means backend function was not found or failed to execute. Verify netlify.toml redirects, function paths, and check Netlify deploy logs for function errors.

Functions not showing in Netlify deploy logs: Incorrect folder paths in netlify.toml or missing plugin.

Login fails (username/email): Ensure login.js correctly queries both email and username.

File upload/download/delete (for general files) not working: Check specific function logs (upload-file.js, list-files.js, get-file.js, delete-file.js) for runtime errors. Verify authentication token is sent correctly from frontend.

Data Dictionary Operations (Save/Load/Print):

Resolution - "Data Dictionary dropdown not populating": This was due to the missing netlify/functions/list-data-dictionaries.js backend function. This function has since been created and deployed. The frontend data-dictionary-builder.js was updated to correctly call this new API.

Resolution - "Data not loading/pre-filling for editing": This issue was resolved by ensuring get-data-dictionary.js correctly returned the structured JSON data (rules_json, source_headers_json) and that data-dictionary-builder.js correctly processed and rendered this data.

Resolution - "Save button not saving data": This was resolved by updating netlify/functions/save-data-dictionary.js to use an explicit SELECT to check for existing dictionaries followed by an UPDATE or INSERT query. This bypasses the previous 42P10 "ON CONFLICT" database error and ensures data is saved reliably. The backend now also sends a more explicit confirmation message (e.g., "Data dictionary 'My Dictionary' saved successfully!").

Resolution - "Print Data Dictionary" not working: This was resolved by implementing the handlePrintDictionary function in data-dictionary-builder.js, which dynamically generates a printable HTML view of the dictionary rules and triggers the print dialog.

Resolution - "Pre-populate existing fields from other dictionaries" not working: This was resolved by updating list-data-dictionaries.js to return rules_json for all dictionaries, and updating data-dictionary-builder.js to store these rules and apply them when a new file is uploaded if matching headers are found.

UI Issues:

Resolution - "Hello, undefined" in navigation: This was resolved by consistently updating the setupNavigation functions (or similar functions like verifyAndSetupUser) across all frontend HTML/JS files (dashboard.html, file-manager.html, tools.html, data-cleaner.html (embedded), data-dictionary-builder.js, validation-engine.html (embedded)) to correctly access the username from the nested user object returned by the protected.js API (userData.user.username).

Resolution - "Your Company: " display: The dashboard.html was updated to correctly display "Your Company: [Company Name]" by accessing userData.user.company_name from the authenticated user data.

Resolution - tools.html displaying tools as cards: The tools.html page's CSS and HTML structure were updated to render tools as distinct, styled cards, consistent with the dashboard's design. Extra "Coming Soon" placeholder tools were removed from tools.html.

Resolution - Redundant validation-engine.css and validation-engine.js files: These files were identified as redundant as validation-engine.html is now self-contained, embedding its CSS and JavaScript directly. They can be safely removed.

Resolution - Branding inconsistency (Excel Buddy vs RCM Buddy): Frontend HTML titles (<title>) and main <h1> headings (index.html, dashboard.html, tools.html, file-manager.html, data-cleaner.html, validation-engine.html, data-dictionary-builder.html) were updated to consistently use "RCM Buddy."

Resolution - "Delete this dictionary" button: The button was removed from the data-dictionary-builder.html UI, and all corresponding JavaScript logic was removed from data-dictionary-builder.js.

Resolution - Validation Tool counting every single row: The analyzeFile function in validation-engine.html was updated to only process non-empty cells for non-REQUIRED validation rules, and to correctly count UNIQUE violations based on non-empty values, addressing the issue of inflated issue counts.

Resolution - Validation Tool "Export Excel with Summary" button not working: Fixed array iteration and filename usage in exportExcelWithSummary in validation-engine.html.

This document provides a complete and up-to-date reference for your RCM Buddy project, including all the recent enhancements and their resolutions.
