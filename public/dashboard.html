<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Buddy - Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-lg">
        <div class="container mx-auto flex flex-col sm:flex-row items-center justify-between">
            <h1 class="text-white text-3xl font-bold mb-2 sm:mb-0">Excel Buddy Dashboard</h1>
            <nav>
                <ul class="flex space-x-4">
                    <li><a href="/tools.html" class="text-white hover:text-blue-200 transition duration-300">Tools</a></li>
                    <li><a href="#" id="profileLink" class="text-white hover:text-blue-200 transition duration-300">Profile</a></li>
                    <li><a href="#" id="logoutBtn" class="text-white hover:text-blue-200 transition duration-300 cursor-pointer">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Section -->
    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl sm:text-3xl font-semibold text-center text-blue-700 mb-4">
                Welcome to your Excel Buddy Dashboard!
            </h2>
            <p id="dashboardMessage" class="text-lg text-gray-700 text-center mb-6">Loading user data and tool insights...</p>

            <div id="userData" class="mt-8 bg-blue-50 p-6 rounded-lg border border-blue-200 hidden">
                <h3 class="text-xl font-semibold text-blue-600 mb-4">Your Profile Information:</h3>
                <p><strong>Username:</strong> <span id="displayUsername"></span></p>
                <p><strong>Email:</strong> <span id="displayEmail"></span></p>
                <p><strong>User ID:</strong> <span id="displayId"></span></p>
                <p><strong>Company:</strong> <span id="displayCompany"></span></p> {/* NEW LINE */}
            </div>

            <!-- Excel Tools & Automation Insights -->
            <div class="mt-8 p-6 bg-purple-50 rounded-lg shadow-md border border-purple-200">
                <h3 class="text-xl font-bold text-purple-600 mb-3">Your Excel Tool Insights at a Glance</h3>
                <p class="text-gray-600">This is where you'd find quick links to your most used tools, recent automation runs, and validation reports.</p>
                <ul class="list-disc list-inside mt-4 text-gray-600">
                    <li>Last Validation Run: 2025-06-07 (Passed: 98%)</li>
                    <li>Automated Reports Generated This Week: 12</li>
                    <li>Favorite Tool: Data Cleaner (57 uses)</li>
                    <li>Upcoming Automation Schedule: Daily at 3:00 AM</li>
                </ul>
                <div class="mt-6 text-center">
                    <a href="/tools.html" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                        Access Your Tools
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white p-4 mt-8">
        <div class="container mx-auto text-center text-sm">
            &copy; 2025 Excel Buddy. All rights reserved.
        </div>
    </footer>

    <script>
        // This script runs when the dashboard page loads.
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwtToken'); // Retrieve the JWT from local storage

            // If no token is found, the user is not logged in. Redirect to the login page.
            if (!token) {
                window.location.href = '/'; // Redirects to index.html
                return; // Stop execution
            }

            // Attempt to fetch protected data using the token
            try {
                const response = await fetch('/api/protected', { // Call the protected Netlify Function
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}` // Send the JWT in the Authorization header
                    }
                });

                const data = await response.json(); // Parse the JSON response

                const dashboardMessage = document.getElementById('dashboardMessage');
                const userDataSection = document.getElementById('userData');
                const displayUsername = document.getElementById('displayUsername');
                const displayEmail = document.getElementById('displayEmail');
                const displayId = document.getElementById('displayId');
                const displayCompany = document.getElementById('displayCompany'); // NEW LINE: Get company display element


                if (response.ok) { // If the response status is 2xx (success)
                    // Display a welcome message with the user's username
                    dashboardMessage.textContent = `Welcome, ${data.user.username}! Here's your Excel automation overview.`;
                    // Populate user data fields
                    displayUsername.textContent = data.user.username;
                    displayEmail.textContent = data.user.email;
                    displayId.textContent = data.user.id;
                    displayCompany.textContent = data.user.company_name; // NEW LINE: Display company name
                    userDataSection.classList.remove('hidden'); // Show the user data section
                    console.log('Protected data fetched successfully:', data);
                } else {
                    // If the token is invalid or expired (e.g., 401 or 403 status)
                    dashboardMessage.textContent = 'Session expired or invalid. Please log in again.';
                    dashboardMessage.className = 'mt-6 text-center text-lg font-medium text-red-700';
                    console.error('Protected route access error:', data.message);
                    localStorage.removeItem('jwtToken'); // Clear invalid token
                    // Redirect to login after a short delay
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                }
            } catch (error) {
                // Catch any network errors during the fetch
                document.getElementById('dashboardMessage').textContent = 'Error fetching dashboard data. Please try again.';
                document.getElementById('dashboardMessage').className = 'mt-6 text-center text-lg font-medium text-red-700';
                console.error('Dashboard fetch error:', error);
                localStorage.removeItem('jwtToken'); // Assume token issue on network error for security
                // Redirect to login after a short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            }
        });

        // --- Logout functionality ---
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('jwtToken'); // Remove the JWT from local storage
            window.location.href = '/'; // Redirect to login page
        });

        // Example: A placeholder for a profile link. In a real app, this might navigate to a dedicated profile page.
        document.getElementById('profileLink').addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            alert('This would navigate to a detailed user profile page.');
        });
    </script>
</body>
</html>
