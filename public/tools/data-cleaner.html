// netlify/functions/clean-excel.js
const Busboy = require('busboy'); // THESE IMPORTS MUST STAY AT THE TOP
const exceljs = require('exceljs'); // THESE IMPORTS MUST STAY AT THE TOP
const { Readable } = require('stream'); // THESE IMPORTS MUST STAY AT THE TOP

exports.handler = async (event, context) => {
    /**
     * Helper function to parse multipart/form-data from Netlify Function event.
     * (Defined INSIDE handler, but NOT recommended)
     */
    function parseMultipartForm(event) {
        return new Promise((resolve, reject) => {
            const busboy = Busboy({ headers: event.headers });
            const fields = {};
            const files = {};
            let fileBuffer = Buffer.from('');

            busboy.on('file', (fieldname, file, filename, encoding, mimetype) => {
                file.on('data', (data) => {
                    fileBuffer = Buffer.concat([fileBuffer, data]);
                });
                file.on('end', () => {
                    files[fieldname] = {
                        filename,
                        encoding,
                        mimetype,
                        data: fileBuffer
                    };
                });
            });

            busboy.on('field', (fieldname, val) => {
                fields[fieldname] = val;
            });

            busboy.on('finish', () => {
                resolve({ fields, files });
            });

            busboy.on('error', reject);

            const readableStream = new Readable();
            readableStream.push(Buffer.from(event.body, event.isBase64Encoded ? 'base64' : 'utf8'));
            readableStream.push(null);

            readableStream.pipe(busboy);
        });
    }

    /**
     * Helper function to apply cleaning operations to a worksheet.
     * (Defined INSIDE handler, but NOT recommended)
     */
    function cleanWorksheet(worksheet, options) {
        let removedDuplicates = 0;
        let trimmedSpaces = 0;
        let standardizedText = 0;

        let rows = [];
        worksheet.eachRow((row, rowNumber) => {
            if (rowNumber === 1 && options.firstRowHeader) {
                rows.push(row.values);
                return;
            }
            rows.push(row.values);
        });

        if (options.trimSpaces === 'true') {
            rows = rows.map(row => row.map(cell => {
                if (typeof cell === 'string') {
                    const originalLength = cell.length;
                    const trimmedCell = cell.trim();
                    if (trimmedCell.length < originalLength) {
                        trimmedSpaces++;
                    }
                    return trimmedCell;
                }
                return cell;
            }));
        }

        if (options.standardizeText === 'true') {
            rows = rows.map(row => row.map(cell => {
                if (typeof cell === 'string') {
                    const originalCell = cell;
                    const standardizedCell = cell.toLowerCase().split(' ').map(word => {
                        return word.charAt(0).toUpperCase() + word.slice(1);
                    }).join(' ');

                    if (standardizedCell !== originalCell) {
                        standardizedText++;
                    }
                    return standardizedCell;
                }
                return cell;
            }));
        }

        if (options.removeDuplicates === 'true') {
            const uniqueRows = new Set();
            const cleanedRows = [];
            rows.forEach(row => {
                const rowString = JSON.stringify(row);
                if (!uniqueRows.has(rowString)) {
                    uniqueRows.add(rowString);
                    cleanedRows.push(row);
                } else {
                    removedDuplicates++;
                }
            });
            rows = cleanedRows;
        }

        worksheet.spliceRows(1, worksheet.actualRowCount);
        rows.forEach(row => {
            worksheet.addRow(row);
        });

        return { removedDuplicates, trimmedSpaces, standardizedText };
    }

    // --- Main handler logic (remains the same) ---
    if (event.httpMethod !== 'POST') {
        return {
            statusCode: 405,
            body: 'Method Not Allowed'
        };
    }

    if (!event.headers['content-type'] || !event.headers['content-type'].includes('multipart/form-data')) {
        return {
            statusCode: 400,
            body: JSON.stringify({ message: 'Content-Type must be multipart/form-data' })
        };
    }

    try {
        const { fields, files } = await parseMultipartForm(event);
        const excelFile = files.excelFile;

        if (!excelFile || !excelFile.data) {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: 'No Excel file uploaded.' })
            };
        }

        const workbook = new exceljs.Workbook();
        await workbook.xlsx.load(excelFile.data);

        let cleaningSummary = { removedDuplicates: 0, trimmedSpaces: 0, standardizedText: 0 };

        workbook.eachSheet((worksheet, id) => {
            const sheetSummary = cleanWorksheet(worksheet, fields);
            cleaningSummary.removedDuplicates += sheetSummary.removedDuplicates;
            cleaningSummary.trimmedSpaces += sheetSummary.trimmedSpaces;
            cleaningSummary.standardizedText += sheetSummary.standardizedText;
        });

        const cleanedFileBuffer = await workbook.xlsx.writeBuffer();

        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: 'File cleaned successfully!',
                cleanedFileBase64: cleanedFileBuffer.toString('base64'),
                summary: cleaningSummary,
                fileName: `cleaned_${excelFile.filename}`
            })
        };

    } catch (error) {
        console.error('Error in clean-excel function:', error);
        return {
            statusCode: 500,
            body: JSON.stringify({ message: 'Error processing Excel file.', error: error.message })
        };
    }
};
