<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Buddy - Validation Engine</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-lg">
        <div class="container mx-auto flex flex-col sm:flex-row items-center justify-between">
            <h1 class="text-white text-3xl font-bold mb-2 sm:mb-0">Validation Engine</h1>
            <nav>
                <ul class="flex space-x-4">
                    <li><a href="/dashboard.html" class="text-white hover:text-blue-200 transition duration-300">Dashboard</a></li>
                    <li><a href="/tools.html" class="text-white hover:text-blue-200 transition duration-300">Tools List</a></li>
                    <li><a href="#" id="profileLink" class="text-white hover:text-blue-200 transition duration-300">Profile</a></li>
                    <li><a href="#" id="logoutBtn" class="text-white hover:text-blue-200 transition duration-300 cursor-pointer">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Section -->
    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl sm:text-3xl font-semibold text-center text-green-700 mb-4">
                Validate Your Excel Data Against Custom Rules
            </h2>
            <p class="text-lg text-gray-700 text-center mb-6">
                Ensure the integrity and accuracy of your spreadsheets by setting up and running powerful validation rules.
            </p>
            <div class="max-w-xl mx-auto text-gray-600 text-base mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <p class="font-semibold text-gray-800 mb-2">About This Tool:</p>
                <p>The **Validation Engine** helps you define and enforce data quality standards for your Excel files. You can specify various types of rules to check for common data issues, ensuring that your spreadsheets contain accurate, complete, and consistent information. This tool is perfect for pre-processing data before analysis, reporting, or database imports.</p>
                <ul class="list-disc list-inside mt-3">
                    <li>**Required Fields:** Ensure critical cells are not left blank.</li>
                    <li>**Data Type Check:** Verify that columns contain expected data types (e.g., numbers, dates, text).</li>
                    <li>**Value Range/List:** Confirm numeric values are within a specified range or text values are from a predefined list.</li>
                    <li>**Unique Values:** Identify and flag duplicate entries in a specific column.</li>
                </ul>
                <p class="mt-3">Upload your file, define your rules, and get a detailed report of any validation failures, allowing you to easily fix issues.</p>
            </div>

            <div class="max-w-xl mx-auto bg-green-50 p-6 rounded-lg shadow-md border border-green-200">
                <h3 class="text-xl font-bold text-green-600 mb-4">Upload File & Define Rules</h3>
                <form id="validationForm" class="space-y-4">
                    <div>
                        <label for="excelFile" class="block text-sm font-medium text-gray-700">Select File (.xlsx, .xls)</label>
                        <input type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls" required
                               class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none focus:border-green-500">
                    </div>

                    <div class="border-t border-gray-200 pt-4">
                        <p class="block text-sm font-medium text-gray-700 mb-2">Validation Rules:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <input id="requiredFields" name="requiredFields" type="checkbox"
                                       class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                <label for="requiredFields" class="ml-2 block text-sm text-gray-900">Required Fields (e.g., Column A must not be empty)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="dataTypeCheck" name="dataTypeCheck" type="checkbox"
                                       class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                <label for="dataTypeCheck" class="ml-2 block text-sm text-gray-900">Data Type Check (e.g., Column B is numeric)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="valueRange" name="valueRange" type="checkbox"
                                       class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                <label for="valueRange" class="ml-2 block text-sm text-gray-900">Value Range/List (e.g., 1-100 or "Yes/No")</label>
                            </div>
                            <div class="flex items-center">
                                <input id="uniqueValues" name="uniqueValues" type="checkbox"
                                       class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                <label for="uniqueValues" class="ml-2 block text-sm text-gray-900">Unique Values (e.g., Column C has no duplicates)</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="validateButton"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                        Run Validation
                    </button>
                </form>

                <div id="statusMessage" class="mt-4 text-center text-gray-700 hidden"></div>
                <div id="validationResults" class="mt-4 p-4 bg-green-100 rounded-lg hidden">
                    <p class="font-semibold text-green-800 mb-2">Validation Results:</p>
                    <ul class="text-green-700 text-sm list-disc list-inside">
                        <li id="totalChecks"></li>
                        <li id="failedChecks"></li>
                        <li id="passedChecks"></li>
                    </ul>
                    <p class="text-xs text-gray-600 mt-2">
                        *A more detailed report with specific errors and row numbers would be provided by the backend.
                    </p>
                </div>
                <div id="downloadSection" class="mt-6 text-center hidden">
                    <p class="text-green-700 font-semibold mb-3">Validation Report Ready!</p>
                    <a id="downloadLink" href="#" download="validation_report.xlsx"
                       class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                        Download Report
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white p-4 mt-8">
        <div class="container mx-auto text-center text-sm">
            &copy; 2025 Excel Buddy. All rights reserved.
        </div>
    </footer>

    <script>
        // --- Authentication Check on Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch('/api/protected', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error verifying token on Validation Engine page:', error);
                localStorage.removeItem('jwtToken');
                window.location.href = '/';
            }
        });

        // --- Logout Functionality ---
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('jwtToken');
            window.location.href = '/';
        });

        // --- Profile Link Placeholder ---
        document.getElementById('profileLink').addEventListener('click', (e) => {
            e.preventDefault();
            alert('This would navigate to a detailed user profile page.');
        });

        // --- Validation Engine Tool Logic ---
        const validationForm = document.getElementById('validationForm');
        const excelFile = document.getElementById('excelFile');
        const validateButton = document.getElementById('validateButton');
        const statusMessage = document.getElementById('statusMessage');
        const validationResults = document.getElementById('validationResults');
        const totalChecks = document.getElementById('totalChecks');
        const failedChecks = document.getElementById('failedChecks');
        const passedChecks = document.getElementById('passedChecks');
        const downloadSection = document.getElementById('downloadSection');
        const downloadLink = document.getElementById('downloadLink');

        validationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Reset UI for new submission
            statusMessage.textContent = 'Running validation... This may take a moment.';
            statusMessage.className = 'mt-4 text-center text-gray-700';
            validationResults.classList.add('hidden');
            downloadSection.classList.add('hidden');
            validateButton.disabled = true;

            const file = excelFile.files[0];
            if (!file) {
                statusMessage.textContent = 'Please select an Excel file to upload.';
                statusMessage.className = 'mt-4 text-center text-red-700';
                validateButton.disabled = false;
                return;
            }

            // Create FormData object to send file and selected rules
            const formData = new FormData();
            formData.append('excelFile', file);
            formData.append('requiredFields', document.getElementById('requiredFields').checked);
            formData.append('dataTypeCheck', document.getElementById('dataTypeCheck').checked);
            formData.append('valueRange', document.getElementById('valueRange').checked);
            formData.append('uniqueValues', document.getElementById('uniqueValues').checked);
            
            try {
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    throw new Error('User not authenticated. Please log in again.');
                }

                // --- ACTIVATE THE REAL BACKEND CALL ---
                const response = await fetch('/api/validate-excel', { // TARGETS YOUR NEW BACKEND FUNCTION
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}` // Include JWT for authentication
                    },
                    body: formData // Send the FormData object
                });

                const result = await response.json(); // Parse the JSON response from the backend

                if (response.ok) {
                    statusMessage.textContent = 'Validation complete!';
                    statusMessage.className = 'mt-4 text-center text-green-700';

                    // Display validation summary from backend result
                    totalChecks.textContent = `Total Checks: ${result.summary.totalChecks}`;
                    failedChecks.textContent = `Failed Checks: ${result.summary.failedChecks}`;
                    passedChecks.textContent = `Passed Checks: ${result.summary.passedChecks}`;
                    validationResults.classList.remove('hidden');

                    // Convert the base64-encoded report from the backend into a Blob
                    const binaryString = atob(result.validationReportBase64); // Decode base64 string
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len); // Create a Uint8Array
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i); // Populate with byte values
                    }
                    const blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); // .xlsx MIME type
                    const url = URL.createObjectURL(blob); // Create a temporary URL for the Blob

                    // Set the download link properties
                    downloadLink.href = url; // Assign the Blob URL to the link
                    downloadLink.download = result.fileName; // Use filename suggested by backend
                    downloadSection.classList.remove('hidden'); // Show download section

                } else {
                    // Handle errors returned from the backend (e.g., 400 Bad Request, 500 Internal Server Error)
                    statusMessage.textContent = `Error: ${result.message || 'Failed to run validation.'}`;
                    statusMessage.className = 'mt-4 text-center text-red-700';
                    console.error('Backend error:', result.error || result.message);
                }
            } catch (error) {
                // Handle network errors or issues before the backend call
                statusMessage.textContent = `Network or authentication error: ${error.message}`;
                statusMessage.className = 'mt-4 text-center text-red-700';
                console.error('Frontend fetch error:', error);
            } finally {
                validateButton.disabled = false; // Always re-enable the button after processing
            }
        });
    </script>
</body>
</html>
