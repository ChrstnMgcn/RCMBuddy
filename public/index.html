<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome - RCM Buddy</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* General body and font styling */
        body {
            font-family: 'Inter', sans-serif;
            color: #212529; /* Default text color */
            /* Background image and styling for the entire body */
            background-image: url('181603687.png'); /* Path to your background image */
            background-size: cover; /* Cover the entire viewport */
            background-position: center; /* Center the background image */
            background-repeat: no-repeat; /* Do not repeat the image */
            background-attachment: fixed; /* Keep image fixed during scroll */
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure body takes full viewport height */
        }

        /* Header styling (consistent with other pages) */
        header {
            @apply bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-lg;
        }
        /* Ensure navigation links in the header are visible */
        header nav ul li a {
            color: white !important; /* Force text to be white */
            padding: 8px 12px; /* Add padding for better click area */
            border-radius: 6px; /* Slightly rounded corners */
        }
        header nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1); /* Subtle hover background */
            color: #bfdbfe !important; /* Tailwind's blue-200 equivalent */
        }
        header nav ul li a.active {
            font-weight: 700; /* Bold for active link */
            background-color: rgba(255, 255, 255, 0.15); /* Slightly darker background for active */
        }


        /* Main content area styling */
        main {
            @apply flex-grow container mx-auto p-4 sm:p-6 lg:p-8 flex items-center justify-center;
            position: relative; /* Needed for the pseudo-element overlay */
            z-index: 1; /* Ensure content is above the overlay */
        }
        /* Overlay for main content area to improve form readability on busy backgrounds */
        main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3); /* Dark semi-transparent overlay */
            z-index: -1; /* Place behind content but above background image */
            border-radius: 8px; /* Match form container's border radius if desired */
        }


        /* Form container styling */
        .auth-container {
            @apply bg-white p-8 sm:p-10 rounded-xl shadow-2xl max-w-md w-full;
            border: 1px solid theme('colors.gray.200'); /* Subtle border */
            margin-top: 2rem; /* Add some top margin to push it down from the header */
            margin-bottom: 2rem; /* Add some bottom margin to separate from footer */
        }
        .auth-container h2 {
            @apply text-3xl font-bold text-center text-blue-700 mb-6;
        }
        .auth-container input {
            @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500;
            color: #212529; /* Ensure input text is dark and readable */
        }
        .auth-container input::placeholder {
            color: #6c757d; /* Darker placeholder for better visibility */
            opacity: 1; /* Ensure full opacity */
        }
        .auth-container button {
            @apply w-full py-3 px-4 rounded-lg text-lg font-semibold text-white transition duration-300 ease-in-out transform;
        }
        .auth-container .primary-btn {
            @apply bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
        }
        .auth-container .secondary-btn {
            @apply bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400;
        }
        .auth-container .link {
            @apply text-blue-600 hover:text-blue-800 transition duration-300;
            font-weight: 500; /* Make the link slightly bolder */
        }
        .message-box {
            @apply p-3 text-center text-sm rounded-md mb-4;
        }
        .message-box.success {
            @apply bg-green-100 text-green-700 border border-green-200;
        }
        .message-box.error {
            @apply bg-red-100 text-red-700 border border-red-200;
        }
        .message-box.info {
            @apply bg-blue-100 text-blue-700 border border-blue-200;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-lg">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="text-white text-3xl font-bold">RCM Buddy</h1>
            <!-- Navigation not typically present on login page, but keeping consistent structure for future if needed -->
            <nav>
                <ul class="flex space-x-4">
                    <li><a href="/" class="text-white hover:text-blue-200 transition duration-300 active">Login</a></li>
                    <!-- Registration link could be here, or handled by a button on the login form itself -->
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Section - Login/Registration Form -->
    <main>
        <div class="auth-container">
            <h2 id="authTitle">Login to RCM Buddy</h2>
            
            <div id="messageBox" class="message-box hidden" role="alert"></div>

            <form id="authForm" class="space-y-6">
                <div>
                    <label for="username" class="sr-only">Username or Email</label>
                    <input type="text" id="username" placeholder="Username or Email" required autocomplete="username" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="sr-only">Password</label>
                    <input type="password" id="password" placeholder="Password" required autocomplete="current-password" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="submitBtn" class="primary-btn">Login</button>
            </form>

            <p class="text-center text-sm text-gray-600 mt-6">
                Don't have an account? <a href="#" id="toggleAuth" class="link">Register here</a>
            </p>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white p-4 mt-8">
        <div class="container mx-auto text-center text-sm">
            &copy; 2025 RCM Buddy. All rights reserved.
        </div>
    </footer>

    <script>
        // Authentication Logic for Login/Registration Page
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const toggleAuthBtn = document.getElementById('toggleAuth');
        const submitBtn = document.getElementById('submitBtn');
        const messageBox = document.getElementById('messageBox');
        let isLogin = true; // State to track if it's currently login or registration

        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Reset classes and add new ones
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // Toggles between Login and Registration forms
        toggleAuthBtn.addEventListener('click', (e) => {
            e.preventDefault();
            hideMessage();
            isLogin = !isLogin;
            if (isLogin) {
                authTitle.textContent = 'Login to RCM Buddy';
                submitBtn.textContent = 'Login';
                toggleAuthBtn.textContent = 'Register here';
                // Remove email field if it was added for registration
                const emailInput = document.getElementById('email');
                if (emailInput) emailInput.parentElement.remove(); 
            } else {
                authTitle.textContent = 'Register for RCM Buddy';
                submitBtn.textContent = 'Register';
                toggleAuthBtn.textContent = 'Login here';
                // Add email field for registration
                const emailDiv = document.createElement('div');
                emailDiv.innerHTML = `<label for="email" class="sr-only">Email</label>
                                      <input type="email" id="email" placeholder="Email" required autocomplete="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">`;
                authForm.insertBefore(emailDiv, document.getElementById('password').parentElement);
            }
        });

        // Handles form submission (Login or Registration)
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();

            const usernameInput = document.getElementById('username').value.trim();
            const passwordInput = document.getElementById('password').value.trim();
            const emailInput = isLogin ? '' : document.getElementById('email').value.trim();

            let endpoint = isLogin ? '/api/login' : '/api/register';
            let payload = { username: usernameInput, password: passwordInput };

            if (!isLogin) {
                if (!emailInput) {
                    showMessage('Please enter your email.', 'error');
                    return;
                }
                // Add a placeholder for company name, as registration needs it on the backend
                // This would ideally be a separate input field on the registration form
                // For now, let's assume a default or infer it if necessary, or simplify for demo.
                // Assuming backend creates a default company or handles missing company name gracefully.
                // If company name is required for registration, you MUST add an input for it here.
                payload = { username: usernameInput, email: emailInput, password: passwordInput, companyName: "Default Company" }; 
            }

            try {
                submitBtn.disabled = true; // Disable button during submission
                submitBtn.textContent = isLogin ? 'Logging in...' : 'Registering...';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    if (isLogin) {
                        localStorage.setItem('jwtToken', data.token);
                        showMessage('Login successful! Redirecting...', 'success');
                        setTimeout(() => {
                            window.location.href = '/dashboard.html'; // Redirect to dashboard
                        }, 1000);
                    } else {
                        showMessage('Registration successful! Please login.', 'success');
                        // Automatically switch to login form after successful registration
                        isLogin = true;
                        authTitle.textContent = 'Login to RCM Buddy';
                        submitBtn.textContent = 'Login';
                        toggleAuthBtn.textContent = 'Register here';
                        const emailInputElem = document.getElementById('email');
                        if (emailInputElem) emailInputElem.parentElement.remove();
                    }
                } else {
                    showMessage(data.message || `Error: ${response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                showMessage('Network error. Please try again later.', 'error');
            } finally {
                submitBtn.disabled = false;
                if (!isLogin) { // Restore original text if still in registration mode
                    submitBtn.textContent = 'Register';
                }
            }
        });

        // Check for existing token on page load to potentially redirect
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                // Attempt to verify token silently
                fetch('/api/protected', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Token invalid or expired');
                    }
                })
                .then(data => {
                    // Token is valid, redirect to dashboard
                    console.log('Token still valid. Redirecting to dashboard.');
                    window.location.href = '/dashboard.html';
                })
                .catch(error => {
                    // Token invalid, expired, or network error. Clear token and stay on login.
                    console.error('Silent token verification failed:', error);
                    localStorage.removeItem('jwtToken');
                    showMessage('Your session has expired. Please log in again.', 'info');
                });
            }
        });
    </script>
</body>
</html>
