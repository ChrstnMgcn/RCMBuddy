<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG MODE - Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/dashboard.html" class="text-2xl font-bold text-gray-800">RCM Buddy</a>
            <ul id="nav-list" class="flex items-center space-x-4">
                <li><span id="nav-username" class="text-gray-700 font-semibold"></span></li>
            </ul>
        </div>
    </nav>
    
    <div class="p-8">
        <h1 class="text-2xl font-bold">Admin Console Debugging Page</h1>
        <p class="mt-2">Check the browser's Developer Console (F12) for log messages.</p>
        <div id="debug-output" class="mt-4 p-4 bg-gray-800 text-white font-mono rounded-lg whitespace-pre-wrap"></div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const output = document.getElementById('debug-output');
            const log = (message) => {
                console.log(message);
                output.textContent += message + '\n';
            };
            const logError = (message, error) => {
                console.error(message, error);
                output.textContent += `\n--- ERROR ---\n${message}\n${error.toString()}\n`;
                output.style.color = '#ff9999';
            };

            log("--- SCRIPT STARTED ---");

            const token = localStorage.getItem('jwtToken');
            if (!token) {
                logError("No JWT token found in localStorage. Cannot proceed.", "");
                return;
            }
            log("Token found in localStorage.");

            // =================================================================
            //                 *** DEBUGGING CATCH BLOCK ***
            // This will now catch the error and log it instead of redirecting.
            // =================================================================
            try {
                // --- STEP 1: Call /api/protected ---
                log("\nAttempting to call /api/protected...");
                const protectedRes = await fetch('/api/protected', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                log(`/api/protected responded with status: ${protectedRes.status}`);

                if (!protectedRes.ok) {
                    const errorData = await protectedRes.json();
                    throw new Error(`Failed /api/protected call. Status ${protectedRes.status}. Message: ${errorData.message}`);
                }
                
                const protectedData = await protectedRes.json();
                const user = protectedData.user;
                log("/api/protected call SUCCEEDED.");
                log(`User role from response: ${user.role}`);
                document.getElementById('nav-username').textContent = `Hello, ${user.username}`;


                // --- STEP 2: Check if user is an admin ---
                if (user.role !== 'admin') {
                    throw new Error("Authorization failed. User role is not 'admin'.");
                }
                log("Role check SUCCEEDED. User is an admin.");


                // --- STEP 3: Call /api/admin/get-company-admin-data ---
                log("\nAttempting to call /api/admin/get-company-admin-data...");
                const adminRes = await fetch('/api/admin/get-company-admin-data', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                log(`/api/admin/get-company-admin-data responded with status: ${adminRes.status}`);
                
                if (!adminRes.ok) {
                    const errorData = await adminRes.json();
                    throw new Error(`Failed /api/admin/get-company-admin-data call. Status ${adminRes.status}. Message: ${errorData.message}`);
                }

                const adminData = await adminRes.json();
                log("/api/admin/get-company-admin-data call SUCCEEDED.");
                log("Data received. Page would normally populate now.");
                log(JSON.stringify(adminData, null, 2));


            } catch (error) {
                logError("An error occurred during the process.", error);
                // The redirect is disabled so we can see the error.
                // window.location.href = '/index.html';
            }
        });
    </script>
</body>
</html>
